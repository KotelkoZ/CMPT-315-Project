<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>315 Project</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/themes/base/jquery-ui.css" type="text/css" media="all" />
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">
            
            // Set up the JQuery
            $(document).ready(function() {
                
                // Hide div#filter_div
                $('div#filter_div').hide();
                $('div#range_div').hide();
                
                // Set the filter panel to open when h2#open_filters clicked
                $('h2#open_filters').click(function() {
                    $(this).next('#filter_div').slideToggle(200);
                    //$(this).toggleClass('close');
                }) // and set the curser to a pointer when hovering
                .css('cursor', 'pointer');
                
                // Set the range panel to open when h3#open_ranges clicked
                $('h3#open_ranges').click(function() {
                    $(this).next('#range_div').slideToggle(200);
                    //$(this).toggleClass('close');
                }) // and set the curser to a pointer when hovering
                .css('cursor', 'pointer');
                
                // Set the curser to a pointer when hovering h3#filter_btn
                $('h3#filter_btn').click(makeChart)
                .css('cursor', 'pointer');
                
                // Create and set the P/E Ratio slider.
                $('div#PERatio_slider').slider({
                    range: true,
                    min: 6,
                    max: 43,
                    values: [6, 43],
                    slide: function( event, ui ) {
                        $('#PERange').val(ui.values[0] + " - " + ui.values[1]);
                    }
                });
                $('#PERange').val($('div#PERatio_slider').slider("values", 0) +
                        " - " + $('div#PERatio_slider').slider("values", 1));
                
                // Create and set the Dividend Yield slider.
                $('div#Div_slider').slider({
                    range: true,
                    min: 0,
                    max: 5.5,
                    values: [0, 5.5],
                    step: 0.1,
                    slide: function( event, ui ) {
                        $('#DivRange').val(ui.values[0] + " - " + ui.values[1]);
                    }
                });
                $('#DivRange').val($('div#Div_slider').slider("values", 0) +
                        " - " + $('div#Div_slider').slider("values", 1));
            }); // End JQuery
            
            // Have to load at beginning. If called after page loads, wipes out HTML
            google.load("visualization", "1", {packages:["corechart"]});
            
            var companyObject;
            var dataTable;
            
            function done() {
                // Called once the page is done loading.
                $.getJSON('http://query.yahooapis.com/v1/public/yql?q=select%20Symbol%2CBookValue%2CDaysLow%2CDaysHigh%2CYearLow%2CYearHigh%2CChangeFromYearLow%2CChangeFromYearHigh%2CName%2COpen%2CPreviousClose%2CChangeinPercent%2CPERatio%2CVolume%2CDividendYield%2CStockExchange%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22SRCE%22%2C%22MMM%22%2C%22ABM%22%2C%22AFL%22%2C%22APD%22%2C%22MO%22%2C%22AWR%22%2C%22ADM%22%2C%22T%22%2C%22ATO%22%2C%22ADP%22%2C%22BDX%22%2C%22BMS%22%2C%22BKH%22%2C%22BRC%22%2C%22BF-B%22%2C%22BCR%22%2C%22CWT%22%2C%22CSL%22%2C%22CVX%22%2C%22CB%22%2C%22CINF%22%2C%22CTAS%22%2C%22CLC%22%2C%22CLX%22%2C%22KO%22%2C%22CL%22%2C%22CBSH%22%2C%22CTBI%22%2C%22CSVI%22%2C%22CTWS%22%2C%22ED%22%2C%22DBD%22%2C%22DCI%22%2C%22DOV%22%2C%22EFSI%22%2C%22EV%22%2C%22EMR%22%2C%22EGN%22%2C%22XOM%22%2C%22FDO%22%2C%22FRT%22%2C%22BEN%22%2C%22GPC%22%2C%22GRC%22%2C%22FUL%22%2C%22HCP%22%2C%22HP%22%2C%22HRL%22%2C%22ITW%22%2C%22JNJ%22%2C%22KMB%22%2C%22LANC%22%2C%22LEG%22%2C%22LOW%22%2C%22MKC%22%2C%22MCD%22%2C%22MHFI%22%2C%22MDT%22%2C%22MCY%22%2C%22MGEE%22%2C%22MSEX%22%2C%22MSA%22%2C%22NC%22%2C%22NFG%22%2C%22NDSN%22%2C%22NWN%22%2C%22NUE%22%2C%22ORI%22%2C%22PH%22%2C%22PNR%22%2C%22PEP%22%2C%22PNY%22%2C%22PPG%22%2C%22PG%22%2C%22STR%22%2C%22RAVN%22%2C%22RLI%22%2C%22RPM%22%2C%22SHW%22%2C%22SIAL%22%2C%22SJW%22%2C%22SON%22%2C%22SWK%22%2C%22SCL%22%2C%22SYY%22%2C%22TROW%22%2C%22TGT%22%2C%22TDS%22%2C%22TNC%22%2C%22TMP%22%2C%22TR%22%2C%22UGI%22%2C%22UBSI%22%2C%22UVV%22%2C%22UHT%22%2C%22VAL%22%2C%22VVC%22%2C%22VFC%22%2C%22GWW%22%2C%22WAG%22%2C%22WMT%22%2C%22WEYS%22%2C%22WGL%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=', 
                    function(file) {
                    companyObject = file.query.results.quote;
                    makeChart();
                });
            }
            
            function makeChart() {
                var NYSEFilter = document.getElementById('NYSEFilter').checked;
                var NASDAQFilter = document.getElementById('NasdaqFilter').checked;
                
                var e = document.getElementById('XSelect');
                var xValue = e.options[e.selectedIndex];
                e = document.getElementById('YSelect');
                var yValue = e.options[e.selectedIndex];
                e = document.getElementById('BSelect');
                var bValue = e.options[e.selectedIndex];
                var chartArray = [['ID', xValue.text, yValue.text, 'Company Name', bValue.text]];
                
                
                companyObject.forEach(function(c) {
                    if ((c.StockExchange == 'NYSE' && NYSEFilter) || (c.StockExchange === 'NasdaqNM' && NASDAQFilter))
                        if (!(isNaN(parseFloat(c[xValue.value])) || isNaN(parseFloat(c[yValue.value])) || isNaN(parseFloat(c[bValue.value]))))
                            chartArray.push([c.Symbol, parseFloat(c[xValue.value]), parseFloat(c[yValue.value]),c.Name, Math.abs(parseFloat(c[bValue.value]))]);
                });
                
                document.getElementById('open_filters').innerHTML = 'Filters - ' + chartArray.length;
                
                dataTable = google.visualization.arrayToDataTable(chartArray);
                var options = {
                    // Options for the chart. Info at
                    // https://google-developers.appspot.com/chart/interactive/docs/gallery/bubblechart
                    hAxis: {title: xValue.text, gridlines: {color: 'none'}},
                    vAxis: {title: yValue.text, gridlines: {color: 'none'}},
                    bubble: {textStyle: {color: 'none'}},
                    legend: {position: 'none'},
                    chartArea: {left: 50, top: 0, width:"85%", height:"90%"},
                    backgroundColor: '#fff',
                    explorer: {keepInBounds: false, maxZoomOut: 1.1}
                };

                // Draw the chart.
                chart = new google.visualization.BubbleChart(document.getElementById('chart_div'));
                chart.draw(dataTable, options);
                console.log('here');
                google.visualization.events.addListener(chart, 'select', selectHandler);
                
                // Bubble selection handler. Calls search on the ticker symbol of the bubble 
                // that was chosen.
                function selectHandler() {
                    console.log('click');
                    var row = chart.getSelection()["0"].row;
                    var symbol = dataTable.getValue(row, 0);
                    search(symbol);
                }
            }
            
            // Load the stock page with the specific stock as an argument.
            function search(term) {
                term = term || document.getElementById('searchBox').value;
                if (term)
                    window.location.href = "stock.html?" + term;
            }
            
        </script>
    </head>

    <body onload="done()">
        <section id="main-content">
            
            <section id="top-panel">
                <!-- HTML Search bar -->
                <h1 id="title">Stock App</h1>
                <div id="sBox">
                    <input type="text" id="searchBox" placeholder="Search For A Ticker" name="searchBox">
                    <input type="submit" id="searchButton" value="Search" onClick="search()">
                </div>
            </section>
            
            <h2 id="open_filters">Filters</h2>
            <div id="filter_div">
                <p>Exchange<br>
                    <input type="checkbox" id="NYSEFilter" checked> NYSE<br>
                    <input type="checkbox" id="NasdaqFilter" checked> NASDAQ
                </p>
                
                <p>X-Axis<br>
                    <select id='XSelect'>
                        <!-- X-Axis selection -->
                        <option value="PERatio">PE Ratio</option>
                        <option value="DaysLow">Days Low</option>
                        <option value="DaysHigh">Days High</option>
                        <option value="YearLow">Year Low</option>
                        <option value="YearHigh">Year High</option>
                        <option value="ChangeFromYearLow">Change From Year Low</option>
                        <option value="ChangeFromYearHigh">Change From Year High</option>
                        <option value="Open">Open</option>
                        <option value="PreviousClose">Previous Close</option>
                        <option value="ChangeinPercent">Percent Change</option>
                        <option value="BookValue">BookValue</option>
                        <option value="DividendYield">Dividend Yield</option>
                    </select>
                </p>
                <p>Y-Axis<br>
                    <select id='YSelect'>
                        <!-- Y-Axis selection -->
                        <option value="DividendYield">Dividend Yield</option>
                        <option value="DaysLow">Days Low</option>
                        <option value="DaysHigh">Days High</option>
                        <option value="YearLow">Year Low</option>
                        <option value="YearHigh">Year High</option>
                        <option value="ChangeFromYearLow">Change From Year Low</option>
                        <option value="ChangeFromYearHigh">Change From Year High</option>
                        <option value="Open">Open</option>
                        <option value="PreviousClose">Previous Close</option>
                        <option value="ChangeinPercent">Percent Change</option>
                        <option value="PERatio">PE Ratio</option>
                        <option value="BookValue">Book Value</option>
                    </select>
                </p>
                <p>Bubble Size<br>
                    <select id='BSelect'>
                        <!-- Bubble size selection -->
                        <option value="Volume">Volume</option>
                        <option value="DaysLow">Days Low</option>
                        <option value="DaysHigh">Days High</option>
                        <option value="YearLow">Year Low</option>
                        <option value="YearHigh">Year High</option>
                        <option value="ChangeFromYearLow">Change From Year Low</option>
                        <option value="ChangeFromYearHigh">Change From Year High</option>
                        <option value="Open">Open</option>
                        <option value="PreviousClose">Previous Close</option>
                        <option value="ChangeinPercent">Percent Change</option>
                        <option value="PERatio">PE Ratio</option>
                        <option value="BookValue">Book Value</option>
                        <option value="DividendYield">Dividend Yield</option>
                    </select>
                </p>
                <h3 id="open_ranges">Limit Ranges</h3>
                <div id="range_div">
                    <p>P/E Ratio<br>
                        <input type="text" id="PERange" readonly>
                        <div id="PERatio_slider"></div>
                    </p>
                    <p>Dividend Yield<br>
                        <input type="text" id="DivRange" readonly>
                        <div id="Div_slider"></div>
                    </p>
                </div>
                
                <h3 id="filter_btn">Filter</h3>
            </div>
            <div id="chart_div"><h2>Loading...</h2></div>
            
        </section>
    </body>
</html>
