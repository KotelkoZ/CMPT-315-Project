<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Stock 315</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/themes/base/jquery-ui.css" type="text/css" media="all" />
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        
        <script>
            var companies = {};
            
            google.load('visualization', '1', {'packages':['annotatedtimeline']});
            google.setOnLoadCallback();
            
            $(document).ready(function() {
                getData(window.location.search.substring(1), function(column_names) {
                    // Put the column_names into the combo box.
                    var combo = document.getElementById('combo');
                    for (var i = 1; i < column_names.length; i++) {
                        combo.innerHTML += '<option>' + column_names[i] + '</option>';
                    }
                    makeChart();
                });
            });  
            
            function makeChart() {
                var data = new google.visualization.DataTable();
                    
                // Add a date column to the chart, then a column for each company in companies map.
                data.addColumn('date', 'Date');
                for (var i = Object.keys(companies).length - 1; i >= 0; i--) {
                    data.addColumn('number', Object.keys(companies)[i]);
                }
                    
                // find the company with the oldest data
                var oldestDate = maxCompany(companies);
                var oldestYear = new Date(oldestDate).getFullYear();
                    
                var rows = [];
                //var selectedIndex = document.getElementById('combo').selectedIndex;
                //console.log(document.getElementById('combo').value);
                var mainTicker = document.getElementById('ticker_title').value;
                for (var i = 2014; i >= oldestYear; i--) {
                    // Starting at the current year, go backwards through time. For each year, loop through the companies map, 
                    // and for each company, if there is an entry for that year, add it.
                    var rowEntry = [new Date(i, 11, 31)];
                    
                    for (var j = Object.keys(companies).length - 1; j >= 0; j--) {
                        var company_name = Object.keys(companies)[j];
                        
                        var entry = null;
                        for (var index in companies[company_name]["data"]) {
                            if (new Date(companies[company_name]["data"][index][0]).getFullYear() === i) {
                                var ind = companies[company_name]["column_names"].indexOf(document.getElementById('combo').value);
                                entry = companies[company_name]["data"][index][ind];
                                
                            }
                        }
                        rowEntry.push(entry);
                    }
                    rows.push(rowEntry);
                }
                data.addRows(rows);
                    
                var options = {
                    displayZoomButtons: false,
                    fill: 4,
                    thickness: 2
                }
                    
                var chart = new google.visualization.AnnotatedTimeLine(document.getElementById('stock_chart_div'));
                chart.draw(data, options);
            }
            
            function maxCompany(companies) {
                // Return the name of the company in the companies map that has the most years of data.
                var compName = undefined;
                var oldestDate = new Date();
                for (var name in companies) {
                    var compData = companies[name]["data"];
                    var compDate = new Date(compData[compData.length - 1][0]);
                    if (compDate < oldestDate) {
                        oldestDate = compDate;
                        compName = name;
                    }
                }
                return oldestDate;
            }
            
            function getData(path, callback) {
                // get the JSON file from quandl.
                if (path == "")
                    return;
                
                var url = "/QuandlQuery/tickers/" + path + ".json";
                
                $.getJSON(url, function(company) {
                    if (company.error === undefined) {
                        var name = company["name"].split(" - ")[0];
                        var column_names = company.column_names;
                        var data = company.data;
                        companies[name] = {"column_names":column_names, "data":data};
                        
                        if (Object.keys(companies).length == 1) {
                            // Set the title to the name of the company that the page was called with.
                            document.getElementById('ticker_title').innerHTML = name;
                        }
                        
                        // make the callback.
                        callback(company.column_names);
                    } else {
                        // no results for the query
                    }
                });
            }
            
            function addCompareTicker() {
                var ticker = document.getElementById('compareBox').value;
                if (ticker) {
                    getData(ticker, makeChart);
                    document.getElementById('compareBox').value = "";
                }
            }
            
            function search(term) {
                term = term || document.getElementById('searchBox').value;
                if (term)
                    window.location.href = "stock.html?" + term;
            }
        </script>
        
    </head>
    <body>
        
        <section id="top-panel">
            <a href="index.html"><img src="logo.png"></a>
            <div class="header-buttons float_right">
                <input type="text" id="searchBox" placeholder="Search For A Ticker" name="searchBox">
                <input type="submit" id="searchButton" value="Search" onClick="search()">
            </div>
            <div class="header-buttons float_right">
                <form action="stock_list.html">
                    <input type="submit" id="listButton" value="View Market List">
                </form>
            </div>            
        </section>
            
        <section id="main-content"> 
            <div id="left_column">
                <div class="float_right">
                    <input type="text" id="compareBox" placeholder="Compare With Ticker" name="searchBox">
                    <input type="submit" id="compareButton" value="Compare" onClick="addCompareTicker()">
                </div>
                
                
                <h2 id="ticker_title">Loading...</h2>
                <div id="compared_tickers" class="float_right">tickerlist</div>
                <select id='combo'>
                </select>
                <input type="submit" id="updateButton" value="Update Graph" onClick="makeChart()">
                <div id="stock_chart_div"></div>
            </div>
        </section>
    </body>
</html>