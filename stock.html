<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>315 Project</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/themes/base/jquery-ui.css" type="text/css" media="all" />
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        
        <script>
            var companies = {};
            
            google.load('visualization', '1', {'packages':['annotatedtimeline']});
            
            //getData(window.location.search.substring(1));
            getData("A");
            getData("AA");
            getData("MSFT");
                            
            function getData(path) {
                // get the JSON file from quandl.
                //var url = "http://www.quandl.com/api/v1/datasets/OFDP/DMDRN_" + path + "_ALLFINANCIALRATIOS.json?auth_token=iT1LrBo1Uw79uqJfrKyb";
                
                var url = "tickers/" + path + ".json";
                
                $.getJSON(url, function(company) {
                    if (company.error === undefined) {
                        var name = company["name"].split(" - ")[0];
                        var column_names = company.column_names;
                        var data = company.data;
                        companies[name] = {"column_names":column_names, "data":data};
                        makeChart();
                    } else {
                        // no results for the query
                    }
                });
            }
            
            
            function maxCompany(companies) {
                // Return the name of the company in the companies map that has the most years of data.
                var c = undefined;
                var max = 0;
                for (var name in companies) {
                    if (companies[name]["data"].length > max) {
                        c = name;
                    }
                }
                return c;
            }
            
            function makeChart() {
                var index = 0;
                
                google.setOnLoadCallback(drawChart);
                function drawChart() {
                    var data = new google.visualization.DataTable();
                    
                    // Add a date column to the chart, then a column for each company in companies map.
                    data.addColumn('date', 'Date');
                    for (var company_name in companies) {
                        data.addColumn('number', company_name);
                    }
                    
                    // find the company with the most year entries.
                    var maxLengthCompany = maxCompany(companies);
                
                    var rows = [];
                    for (var i = 0; i < companies[maxLengthCompany]["data"].length; i++) {
                        // Starting at 0, loop up to the last year in the company with the most years.
                        // Create a row entry with the date for this year.
                        var rowEntry = [new Date(companies[maxLengthCompany]["data"][i][0])];
                        for (var company_name in companies) {
                            // Go through the companies in the map and add an entry for the current year.
                            rowEntry.push(companies[company_name]["data"][i][2]);
                        }
                        // Push the whole row entry into the row array.
                        rows.push(rowEntry);
                    }
                    data.addRows(rows);

                    var chart = new google.visualization.AnnotatedTimeLine(document.getElementById('main_div'));
                    chart.draw(data, {displayAnnotations: true});
                }

            }
                            
                            
        </script>
        
    </head>
    <body>
        <section id="main-content">
            
            <section id="top-panel">
                <!-- HTML Search bar -->
                <h1 id="title">Stock App</h1>
                <div id="sBox">
                    <input type="text" id="searchBox" placeholder="Search For A Ticker" name="searchBox">
                    <input type="submit" id="searchButton" value="Search" onClick="search()">
                </div>
            </section>
        
            <div id="main_div"><h2>Loading...</h2></div>
        </section>
    </body>
</html>