<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Stock 315</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/themes/base/jquery-ui.css" type="text/css" media="all" />
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        
        <script>
            var companies = {};
            
            google.load('visualization', '1', {'packages':['annotatedtimeline']});
            google.setOnLoadCallback();
            
            $(document).ready(function() {
                getData(window.location.search.substring(1));
                //getData("MSFT");
                         
            });  
            
            function makeChart() {
                var index = 0;
                
                //if (Object.keys(companies).length > 1) {
                    drawChart()
                //} else {
                    console.log('a');
                    //google.setOnLoadCallback(drawChart);
               // }
                
                function drawChart() {
                    console.log('b');
                    var data = new google.visualization.DataTable();
                    
                    // Add a date column to the chart, then a column for each company in companies map.
                    data.addColumn('date', 'Date');
                    for (var company_name in companies) {
                        data.addColumn('number', company_name);
                    }
                    
                    // find the company with the most year entries.
                    var maxLengthCompany = maxCompany(companies);
                
                    var rows = [];
                    for (var i = 0; i < companies[maxLengthCompany]["data"].length; i++) {
                        // Starting at 0, loop up to the last year in the company with the most years.
                        // Create a row entry with the date for this year.
                        var rowEntry = [new Date(companies[maxLengthCompany]["data"][i][0])];
                        for (var company_name in companies) {
                            // Go through the companies in the map and add an entry for the current year.
                            rowEntry.push(companies[company_name]["data"][i][2]);
                        }
                        // Push the whole row entry into the row array.
                        rows.push(rowEntry);
                    }
                    data.addRows(rows);
                    
                    var options = {
                        displayZoomButtons: false,
                        fill: 10,
                        thickness: 5
                    }
                    
                    var chart = new google.visualization.AnnotatedTimeLine(document.getElementById('stock_chart_div'));
                    chart.draw(data, options);
                }

            }
            
            function maxCompany(companies) {
                // Return the name of the company in the companies map that has the most years of data.
                var c = undefined;
                var max = 0;
                for (var name in companies) {
                    if (companies[name]["data"].length > max) {
                        c = name;
                    }
                }
                return c;
            }
            
            function getData(path) {
                // get the JSON file from quandl.
                if (path == "")
                    return;
                //var url = "http://www.quandl.com/api/v1/datasets/OFDP/DMDRN_" + path + "_ALLFINANCIALRATIOS.json?auth_token=iT1LrBo1Uw79uqJfrKyb";
                
                var url = "tickers/" + path + ".json";
                
                $.getJSON(url, function(company) {
                    if (company.error === undefined) {
                        var name = company["name"].split(" - ")[0];
                        var column_names = company.column_names;
                        var data = company.data;
                        companies[name] = {"column_names":column_names, "data":data};
                        makeChart();
                        
                        if (Object.keys(companies).length == 1) {
                            // Set the title to the name of the company that the page was called with.
                            document.getElementById('ticker_title').innerHTML = name;
                        }
                    } else {
                        // no results for the query
                    }
                });
            }
            
            function addCompareTicker() {
                var ticker = document.getElementById('compareBox').value;
                if (ticker) {
                    getData(ticker);
                    document.getElementById('compareBox').value = "";
                }
            }
            
            function search(term) {
                term = term || document.getElementById('searchBox').value;
                if (term)
                    window.location.href = "stock.html?" + term;
            }
        </script>
        
    </head>
    <body>
        
        <section id="top-panel">
            <a href="index.html"><img src="logo.png"></a>
            <div class="header-buttons float_right">
                <input type="text" id="searchBox" placeholder="Search For A Ticker" name="searchBox">
                <input type="submit" id="searchButton" value="Search" onClick="search()">
            </div>
            <div class="header-buttons float_right">
                <form action="stock_list.html">
                    <input type="submit" id="listButton" value="View Market List">
                </form>
            </div>            
        </section>
            
        <section id="main-content"> 
            <div id="left_column">
                <div class="float_right">
                    <input type="text" id="compareBox" placeholder="Compare With Ticker" name="searchBox">
                    <input type="submit" id="compareButton" value="Compare" onClick="addCompareTicker()">
                </div>
                <div id="compared_tickers" class="float_right"></div>
                <h2 id="ticker_title">Loading...</h2>
                <div id="stock_chart_div"></div>
            </div>
        </section>
    </body>
</html>