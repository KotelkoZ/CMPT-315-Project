<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Stock 315</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/themes/base/jquery-ui.css" type="text/css" media="all" />
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        
        <script>
            var companies = {};
            
            google.load('visualization', '1', {'packages':['annotatedtimeline']});
            google.setOnLoadCallback();
            
            $(document).ready(function() {
                getData(window.location.search.substring(1));
                //getData("MSFT");
                         
            });  
            
            function makeChart() {
                
                //function drawChart() {
                    console.log('b');
                    var data = new google.visualization.DataTable();
                    
                    // Add a date column to the chart, then a column for each company in companies map.
                    data.addColumn('date', 'Date');
                    for (var i = Object.keys(companies).length - 1; i >= 0; i--) {
                        data.addColumn('number', Object.keys(companies)[i]);
                    }
                    
                    
                    // find the company with the most year entries.
                    var maxLengthCompany = maxCompany(companies);
                    
                    var rows = [];
                    var selectedIndex = document.getElementById('combo').selectedIndex;
                    var mainTicker = document.getElementById('ticker_title').value;
                    
                    for (var i = 0; i < companies[maxLengthCompany]["data"].length; i++) {
                        // Starting at 0, loop up to the last year in the company with the most years.
                        // Create a row entry with the date for this year.
                        var rowEntry = [new Date(companies[maxLengthCompany]["data"][i][0])];
                        
                        
                        for (var company_name in companies) {
                            // Go through the companies in the map and add an entry for the current year.
                                                
                            var entry = null;
                            if (i < companies[company_name]["data"].length) {
                                entry = companies[company_name]["data"][i][selectedIndex + 1]
                            }
                            rowEntry.push(entry);
                        }
                        
                        // Push the whole row entry into the row array.
                        // Swap the main ticker to the end of the array. This is so that the small grpah 
                        // on the bottom always shows the main ticker.
                        var temp = rowEntry[1];
                        rowEntry[1] = rowEntry[rowEntry.length - 1];
                        rowEntry[rowEntry.length - 1] = temp;
                        rows.push(rowEntry);
                    }
                    data.addRows(rows);
                    
                    var options = {
                        displayZoomButtons: false,
                        fill: 10,
                        thickness: 5
                    }
                    
                    var chart = new google.visualization.AnnotatedTimeLine(document.getElementById('stock_chart_div'));
                    chart.draw(data, options);
               // }

            }
            
            function maxCompany(companies) {
                // Return the name of the company in the companies map that has the most years of data.
                var c = undefined;
                var max = 0;
                for (var name in companies) {
                    if (companies[name]["data"].length > max) {
                        c = name;
                        max = companies[name]["data"].length;
                    }
                }
                return c;
            }
            
            function getData(path) {
                // get the JSON file from quandl.
                if (path == "")
                    return;
                //var url = "http://www.quandl.com/api/v1/datasets/OFDP/DMDRN_" + path + "_ALLFINANCIALRATIOS.json?auth_token=iT1LrBo1Uw79uqJfrKyb";
                
                var url = "tickers/" + path + ".json";
                
                $.getJSON(url, function(company) {
                    if (company.error === undefined) {
                        var name = company["name"].split(" - ")[0];
                        var column_names = company.column_names;
                        var data = company.data;
                        companies[name] = {"column_names":column_names, "data":data};
                        makeChart();
                        
                        if (Object.keys(companies).length == 1) {
                            // Set the title to the name of the company that the page was called with.
                            document.getElementById('ticker_title').innerHTML = name;
                        }
                    } else {
                        // no results for the query
                    }
                });
            }
            
            function addCompareTicker() {
                var ticker = document.getElementById('compareBox').value;
                if (ticker) {
                    getData(ticker);
                    document.getElementById('compareBox').value = "";
                }
            }
            
            function search(term) {
                term = term || document.getElementById('searchBox').value;
                if (term)
                    window.location.href = "stock.html?" + term;
            }
        </script>
        
    </head>
    <body>
        
        <section id="top-panel">
            <a href="index.html"><img src="logo.png"></a>
            <div class="header-buttons float_right">
                <input type="text" id="searchBox" placeholder="Search For A Ticker" name="searchBox">
                <input type="submit" id="searchButton" value="Search" onClick="search()">
            </div>
            <div class="header-buttons float_right">
                <form action="stock_list.html">
                    <input type="submit" id="listButton" value="View Market List">
                </form>
            </div>            
        </section>
            
        <section id="main-content"> 
            <div id="left_column">
                <div class="float_right">
                    <input type="text" id="compareBox" placeholder="Compare With Ticker" name="searchBox">
                    <input type="submit" id="compareButton" value="Compare" onClick="addCompareTicker()">
                </div>
                
                
                <h2 id="ticker_title">Loading...</h2>
                <div id="compared_tickers" class="float_right">tickerlist</div>
                <select id='combo'>
                    <option>Number of Shares Outstanding</option>
                    <option>3-Year Regression Beta</option>
                    <option>3-Year Standard Deviation of Stock Price</option>
                    <option>Book Debt to Capital Ratio</option>
                    <option>Book Value of Equity</option>
                    <option>Book Value of Assets</option>
                    <option>Capital Expenditures</option>
                    <option>Cash</option>
                    <option>Cash as Percentage of Firm Value</option>
                    <option>Cash as Percentage of Revenues</option>
                    <option>Cash as Percentage of Total Assets</option>
                    <option>Change in Non-Cash Working Capital</option>
                    <option>Correlation with the Market</option>
                    <option>Current PE Ratio</option>
                    <option>Depreciation</option>
                    <option>Dividend Yield</option>
                    <option>Dividends</option>
                    <option>Earnings Before Interest and Taxes</option>
                    <option>EBIT for Previous Period</option>
                    <option>Earnings Before Interest Taxes Depreciation and Amortization</option>
                    <option>Effective Tax Rate</option>
                    <option>Effective Tax Rate on Income</option>
                    <option>Enterprise Value</option>
                    <option>EV to Invested Capital Ratio</option>
                    <option>EV to Trailing Sales Ratio</option>
                    <option>EV to EBIT Ratio</option>
                    <option>EV to EBITDA Ratio</option>
                    <option>EV to Sales Ratio</option>
                    <option>Expected Growth in Earnings Per Share</option>
                    <option>Expected Growth in Revenues</option>
                    <option>Free Cash Flow to Firm</option>
                    <option>Firm Value</option>
                    <option>Ratio of Fixed Assets to Total Assets</option>
                    <option>Forward Earnings Per Share</option>
                    <option>Forward PE Ratio</option>
                    <option>Growth in Earnings Per Share</option>
                    <option>Previous Year Growth in Revenues</option>
                    <option>Hi-Lo Risk</option>
                    <option>Insider Holdings</option>
                    <option>Institutional Holdings</option>
                    <option>Ratio of Intangible Assets to Total Assets</option>
                    <option>Invested Capital</option>
                    <option>Market Capitalization</option>
                    <option>Market Debt to Equity Ratio</option>
                    <option>Market Debt to Capital Ratio</option>
                    <option>Net Income</option>
                    <option>Net Margin</option>
                    <option>Non-Cash Working Capital</option>
                    <option>Non-Cash Working Capital as Percentage of Revenues</option>
                    <option>Payout Ratio</option>
                    <option>Price to Book Value Ratio</option>
                    <option>PE to Growth Ratio</option>
                    <option>Pre-Tax Operating Margin</option>
                    <option>Price to Sales Ratio</option>
                    <option>Reinvestment Amount</option>
                    <option>Reinvestment Rate</option>
                    <option>Revenues</option>
                    <option>Return on Capital</option>
                    <option>Return on Equity</option>
                    <option>Sales General Administration Expenses</option>
                    <option>Stock Price</option>
                    <option>Total Debt</option>
                    <option>Trading Volume</option>
                    <option>Trailing 12-month Revenues</option>
                    <option>Trailing Net Income</option>
                    <option>Trailing PE Ratio</option>
                    <option>Trailing Revenues</option>
                    <option>Value Line Beta</option>
                </select>
                <input type="submit" id="updateButton" value="Update Graph" onClick="makeChart()">
                <div id="stock_chart_div"></div>
            </div>
        </section>
    </body>
</html>